# Пример лабораторной Lab2 SCR1 sim

## Задание

|Вариант|Вид исключения     |Тест	               |Reset Vector|Trap Vector|При обработке
|-------|-------------------|--------------------|------------|-----------|---------------------
|1      |Illegal instruction|isa/rv32mi/illegal.S|0х400       |0x200      |Вывод строки «ILLEGAL»

## Выполнение

Для выполнения лабораторной работы было сделано: 
1. Загрузила GNU make версии 4.0, симулятор Verilator версии 4.102, RISC-V GCC toolchain.
2. Правильно настроила их (раза с десятого)
3. Поплакала, потому что несколько суток думала, что я делаю не так, а делает не так все MacOS
4. Подружилась с виртуальной машиной Ubuntu
5. Убедилась, что проект собирается и все тесты проходят в симуляции до внесения изменений проект (это казалось пыткой, но я не знала, что ждет меня впереди)
6. Зашла в файлик ./sim/tests/riscv-isa/rv32_tests.inc с помощью vim и удалила в нем названия всех тестов, кроме одного, доставшего по варианту (тест isa/rv32mi/illegal.S)
7. Запустила симуляцию с нужными мне параметрами, а именно:
```linux
make run_verilator TARGETS="riscv_isa" TRACE=1
```
- включила TRACE, чтобы генерировался трейслог
- в качестве таргета (цели) выбрала группу тестов riscv_isa (потому что еще есть тесты riscv_compiliance, которые я не редактировала)
8. Убедилась, что проходит только 1 нужный мне тест, трейслог прохождения находился в директории build
9. В соответствии с вариантом задания модифицировала обработку исключений trap_vector в файле ./sim/tests/common/riscv_macros.h.
(К сожалению, не знаю, правильно ли, ибо благодаря 6 пункту в задании, работоспособность моей обработки исключения я проверить так и не могу)
Я добавила:
- константу SCR1_SIM_PRINT_ADDR, чтобы записывать символы по адресу в SCR1_SIM_PRINT_ADDR, так как если мы запишем символы в тестбенчевую память по заданному адресу, они выведутся на экран
- функцию, которая будет пихать символы, переданные ей, в память по заданному адресу
- код по метке handle_exception (добавила обработку исключения illegal instruction)
```c
#define SCR1_SIM_PRINT_ADDR (0xf0000000)

#define RVTEST_PUTCHAR(c)                                               \
        li a0, (c);                                                     \
        sb a0, 0(a1);
     
handle_exception:                                                       \
        li a6, 0x2;                                                     \
        bne a4, a6, other_exception;                                    \
        li a1, SCR1_SIM_PRINT_ADDR;                                     \                        
        RVTEST_PUTCHAR('I');                                            \ 
        RVTEST_PUTCHAR('L');                                            \
        RVTEST_PUTCHAR('L');                                            \ 
        RVTEST_PUTCHAR('E');                                            \
        RVTEST_PUTCHAR('G');                                            \
        RVTEST_PUTCHAR('A');                                            \
        RVTEST_PUTCHAR('L');                                            \
other_exception:
        ...

```
10. Установила в файле  ./src/includes/scr1_arch_description.svh параметры ядра Reset Vector = 0x400 и Trap Vector = 0x200 в соответствии с вариантом задания.

```verilog
parameter bit [`SCR1_XLEN-1:0]          SCR1_ARCH_RST_VECTOR        = 'h400;            // Reset vector value (start address after reset)
parameter bit [`SCR1_XLEN-1:0]          SCR1_ARCH_MTVEC_BASE        = 'h200;            // MTVEC.base field reset value, or constant value for MTVEC.base bits that are hardwired
```
11. А вот тут наступил кризис возможностей моего интеллекта. Я понимаю, что после изменения reset vector'а и trap vector'а в scr1_arch_description.svh, они отразятся только в трейслоге, но в дамп файле адреса останутся прежними. Я знаю, что нужно как-то изменить ./sim/tests/common/link.ld, чтобы вектора были корректно установлены и симулятор не фейлился. Но пока не совсем понимаю как
Я пыталась выделить дополнительную область памяти , чтобы она была отведена под .text .init (так как судя по дизассемблеированию trap_vector и _start задавались там). Но я не совсем понимаю по какому принципу менять адреса. Так как там все взаимосвязано (непонятно, как изменить кокнкретный фрагмент под свои нужды, не испортив остальные фрагменты).
Я все же верю в свои силы и попытаюсь найти решение. C linker-скриптами у нас все впереди и я уверена, что мы придем к соглашению

12. Сохранила в директории ./results: результат симуляции (test_results.txt), дизассемблер теста (*.dump) и трейс лог (tracelog_core_0.log).
13. Создала в директории ./results файл с отчетом по проделанной README.md (который заполняю сейчас) ((упс)) (((На самом деле просто пользоваться текстовым редактором в vime и на виртуальной машине - сомнительное удовольствие)))
14. Пройдя еще через 7 кругов ада запушила все произведенные изменения в ветку lab_sim (из-за чего, собственно, и опоздала на 5 минут) ((Боже, храни stackOverFlow, иначе 5 минут превратились бы в 5 суток)) 

## Результаты

* Из результата симуляции **test_results.txt** видно, что был выбран только необходимый тест и тест ~~успешно выполнился~~ зафейлился (причина, на мой взгляд, кроется в 11 пункте).
* Из дампа теста **add.dump** видно, что trap_vector ~~корректно установлен по адресу 0x200~~ к сожалению, не изменился, а _start ~~по адресу 0x240~~ к сожалению, так же не изменился.
* Из трейслога **tracelog_core_0.log** видно, что процессор начинает работать с адреса 0х400 и при возникновении exception переходит по адресу 0x200.
